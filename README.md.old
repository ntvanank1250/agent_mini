# ğŸ¤– AI Agent Local - Telegram Bot + Ollama + Web UI

Há»‡ thá»‘ng AI Agent cÃ¡ nhÃ¢n cháº¡y cá»¥c bá»™ (Local) trÃªn Linux vá»›i 8GB RAM, tÃ­ch há»£p Telegram Bot, Ollama AI Engine, vÃ  giao diá»‡n Web giá»‘ng ChatGPT.

## ğŸ“‹ TÃ­nh NÄƒng

- âœ… **Ollama AI Integration**: qwen2.5:7b model (tá»‘i Æ°u tiáº¿ng Viá»‡t)
- âœ… **Telegram Bot**: TÆ°Æ¡ng tÃ¡c qua Telegram Messenger
- âœ… **Web Interface**: Open WebUI giá»‘ng Zerobot/ChatGPT (port 3000)
- âœ… **Conversation Memory**: LÆ°u lá»‹ch sá»­ chat vÃ o SQLite
- âœ… **Queue System**: Xá»© lÃ½ 1 request AI táº¡i má»™t lÃºc (8GB RAM optimized)
- âœ… **File Processing**: PhÃ¢n tÃ­ch file .txt tá»± Ä‘á»™ng
- âœ… **System Monitoring**: Kiá»ƒm tra RAM/CPU real-time
- âœ… **Memory Optimization**: Garbage collection, swap file, caching
- âœ… **Access Control**: Chá»‰ cho phÃ©p 1 admin sá»­ dá»¥ng

## ğŸ› ï¸ YÃªu Cáº§u Há»‡ Thá»‘ng

```
Hardware:
  - CPU: 4 Core (khuyáº¿n nghá»‹)
  - RAM: 8GB (cáº§n 6GB cho Ollama + 2GB cho há»‡ thá»‘ng)
  - Disk: 20GB (cho model + data)
  - Network: Káº¿t ná»‘i internet Ä‘á»ƒ cÃ i Ä‘áº·t

OS:
  - Ubuntu 20.04 LTS hoáº·c cao hÆ¡n
  - Linux based (Debian, CentOS, etc)
```

## ğŸš€ Quick Start

### 1ï¸âƒ£ Clone & Cáº¥u HÃ¬nh

```bash
cd /home/hieudd/code/agent_mini

# Copy file cáº¥u hÃ¬nh
cp .env.example .env

# Chá»‰nh sá»­a .env vá»›i thÃ´ng tin cá»§a báº¡n
nano .env
```

### 2ï¸âƒ£ Cháº¡y Setup Script

```bash
# Cáº¥p quyá»n thá»±c thi
chmod +x setup_system.sh

# Cháº¡y script (cáº§n sudo)
sudo ./setup_system.sh

# This sáº½:
# âœ“ Táº¡o 4GB swap file (RAM optimization)
# âœ“ CÃ i Ollama + Pull qwen2.5:7b model (~5GB, máº¥t 10-15 phÃºt)
# âœ“ CÃ i Docker + Open WebUI image
# âœ“ Táº¡o Python venv + install dependencies
# âœ“ Kiá»ƒm tra toÃ n bá»™ cÃ i Ä‘áº·t
```

### 3ï¸âƒ£ Khá»Ÿi Äá»™ng Ollama

```bash
# CÃ¡ch 1: Sá»­ dá»¥ng systemd (recommended)
sudo systemctl start ollama
sudo systemctl enable ollama  # Tá»± Ä‘á»™ng start khi reboot

# CÃ¡ch 2: Cháº¡y thá»§ cÃ´ng
ollama serve

# Kiá»ƒm tra
ollama list
```

### 4ï¸âƒ£ Khá»Ÿi Äá»™ng Web UI (Optional)

```bash
# Náº¿u Ä‘Ã£ cÃ i Docker
docker run -d -p 3000:8080 --name open-webui \
  -e OLLAMA_BASE_URL=http://localhost:11434 \
  ghcr.io/open-webui/open-webui:latest

# Truy cáº­p: http://localhost:3000
```

### 5ï¸âƒ£ Khá»Ÿi Äá»™ng Telegram Bot

```bash
# Activate virtual environment
source venv/bin/activate

# Cháº¡y bot
python3 tele_agent.py

# Output:
# INFO - Starting AI Agent Bot...
# INFO - Admin Chat ID: 123456789
# INFO - Model: qwen2.5:7b
```

## ğŸ“± Sá»­ Dá»¥ng Telegram Bot

### Lá»‡nh Há»‡ Thá»‘ng

| Lá»‡nh | MÃ´ táº£ |
|------|-------|
| `/start` | Khá»Ÿi Ä‘á»™ng bot, xem thÃ´ng tin |
| `/help` | HÆ°á»›ng dáº«n chi tiáº¿t |
| `/sys` | Kiá»ƒm tra RAM, CPU, Queue status |
| `/clear` | XÃ³a lá»‹ch sá»­ chat |

### TÆ°Æ¡ng TÃ¡c

1. **Chat bÃ¬nh thÆ°á»ng**: Gá»­i text, bot sáº½ tráº£ lá»i
2. **Gá»­i file**: Upload file .txt, bot sáº½ phÃ¢n tÃ­ch
3. **Queue notification**: Náº¿u AI Ä‘ang xá»­ lÃ½, sáº½ thÃ´ng bÃ¡o vá»‹ trÃ­ chá»

**VÃ­ dá»¥:**
```
Báº¡n: HÃ´m nay thá»i tiáº¿t tháº¿ nÃ o?
Bot: Äang Ä‘á»£i... (Vá»‹ trÃ­ trong hÃ ng: #1)
     (sau 30-60 giÃ¢y)
    Xin lá»—i, tÃ´i khÃ´ng cÃ³ thÃ´ng tin thá»i tiáº¿t real-time...

Báº¡n: /sys
Bot: ğŸ“Š SYSTEM STATUS REPORT
     Memory: Total: 8.0GB
             Used: 5.2GB (65%)
             Available: 2.8GB
     CPU: Cores: 4
          Usage: 35%
     AI Queue: Processing: Yes
                Queue: 0
```

## ğŸ“ Cáº¥u TrÃºc File

```
agent_mini/
â”œâ”€â”€ setup_system.sh          # Script cÃ i Ä‘áº·t tá»± Ä‘á»™ng
â”œâ”€â”€ tele_agent.py            # Telegram Bot + AI Engine
â”œâ”€â”€ .env.example             # Template cáº¥u hÃ¬nh
â”œâ”€â”€ .env                     # Cáº¥u hÃ¬nh thá»±c táº¿ (create tá»« .env.example)
â”œâ”€â”€ bot_agent.log            # Log file (tá»± Ä‘á»™ng táº¡o)
â””â”€â”€ data/
    â”œâ”€â”€ chat_history.db      # SQLite database
    â””â”€â”€ temp_files/          # ThÆ° má»¥c táº¡m file upload
```

## ğŸ”‘ Láº¥y Telegram Bot Token

1. Má»Ÿ Telegram, tÃ¬m `@BotFather`
2. Gá»­i `/newbot`
3. Äáº·t tÃªn bot (vÃ­ dá»¥: MyAIBot)
4. Láº¥y token (vÃ­ dá»¥: `123456:ABC-DEF1234ghIkl-zyx57W2v1u123ew11`)
5. Paste vÃ o `.env` file

## ğŸ‘¤ Láº¥y Chat ID

1. TÃ¬m `@userinfobot` trÃªn Telegram
2. Gá»­i `/start` 
3. Láº¥y ID vÃ  paste vÃ o `.env`

**Hoáº·c**: Gá»­i `/help` cho bot, sáº½ hiá»ƒn thá»‹ chat ID

## âš™ï¸ Optimization cho 8GB RAM

### Swap File
```bash
# Kiá»ƒm tra swap
free -h
swapon --show

# Script tá»± Ä‘á»™ng táº¡o 4GB swap file
```

### Ollama Optimization
- Model: qwen2.5:7b (~7GB)
- Threads: 4 (tá»‘i Æ°u 4-core CPU)
- Context window: 2048 tokens
- Memory cleanup: Auto gc.collect() every 5 responses

### Python Optimization
- Single worker queue (chá»‰ 1 AI request táº¡i má»™t lÃºc)
- History limit: 20 messages
- Message length limit: 4000 chars
- Async/await for non-blocking I/O

## ğŸ“Š Monitoring

### Real-time Monitor
```bash
# Terminal 1: Watch system resources
watch -n 1 'free -h && echo && ps aux | grep ollama'

# Terminal 2: Watch bot logs
tail -f bot_agent.log

# Terminal 3: Check Ollama
watch -n 1 'ollama list && echo && ollama ps'
```

### Database Queries
```bash
# Check conversation history
sqlite3 data/chat_history.db "SELECT * FROM conversations LIMIT 10;"

# Check user stats
sqlite3 data/chat_history.db "SELECT * FROM users;"

# Delete old messages (older than 30 days)
sqlite3 data/chat_history.db "
DELETE FROM conversations 
WHERE datetime(timestamp) < datetime('now', '-30 days');
"
```

## ğŸ› Troubleshooting

### "Permission denied" on setup_system.sh
```bash
chmod +x setup_system.sh
sudo ./setup_system.sh
```

### Ollama "Address already in use"
```bash
# Kill existing process
pkill -f ollama

# Or check what's using port 11434
lsof -i :11434
```

### ImportError: cannot import name 'ChatAction'
```bash
# Ensure correct python-telegram-bot version
source venv/bin/activate
pip install --upgrade python-telegram-bot==20.7
```

### Bot khÃ´ng respond
```bash
# 1. Check .env file
cat .env | grep TELEGRAM_API_TOKEN

# 2. Test Telegram connection
python3 -c "from telegram import Bot; print(Bot('YOUR_TOKEN').getMe())"

# 3. Check logs
tail -f bot_agent.log
```

### Out of Memory (OOM)
```bash
# Check memory usage
ps aux --sort=-%mem | head -10

# Check swap
free -h

# Increase swap if needed
sudo fallocate -l 4G /swapfile2
sudo mkswap /swapfile2
sudo swapon /swapfile2
```

### Slow Response
```bash
# 1. Check CPU usage
top -b -n 1 | head -10

# 2. Check if queue is building up
# Use /sys command on Telegram

# 3. Reduce context window in code
# Edit tele_agent.py line: 'num_ctx': 1024  (from 2048)
```

## ğŸ”§ Advanced Configuration

### Thay Ä‘á»•i Model
```bash
# Edit .env
OLLAMA_MODEL=qwen2.5:14b  # Cháº­m hÆ¡n, chÃ­nh xÃ¡c hÆ¡n
# hoáº·c
OLLAMA_MODEL=mistral  # Nhanh hÆ¡n, nhÆ°ng kÃ©m tiáº¿ng Viá»‡t

# Pull model
ollama pull qwen2.5:14b

# Restart bot
python3 tele_agent.py
```

### Äiá»u chá»‰nh Queue
```python
# tele_agent.py - line 83
QUEUE_CHECK_INTERVAL = 1  # Kiá»ƒm tra thÆ°á»ng xuyÃªn hÆ¡n
MAX_WORKERS = 1  # Giá»¯ = 1 Ä‘á»ƒ tá»‘i Æ°u

# Hoáº·c tÄƒng Ä‘á»ƒ xá»­ lÃ½ nhiá»u request
MAX_WORKERS = 2  # NhÆ°ng cáº§n 16GB RAM
```

### Custom System Prompt
```python
# tele_agent.py - AIAgent.generate_response() method
system_prompt = """Báº¡n lÃ  má»™t chuyÃªn gia vá» láº­p trÃ¬nh Python...
..."""
```

## ğŸ“š TÃ i Liá»‡u Tham Kháº£o

- [Ollama Documentation](https://ollama.ai)
- [python-telegram-bot](https://python-telegram-bot.readthedocs.io)
- [Open WebUI](https://github.com/open-webui/open-webui)
- [qwen2.5 Model Info](https://huggingface.co/Qwen/Qwen2.5-7B)

## ğŸ“ License

MIT License - Tá»± do sá»­ dá»¥ng cho má»¥c Ä‘Ã­ch cÃ¡ nhÃ¢n

## ğŸ¤ Support

Gáº·p váº¥n Ä‘á»? Kiá»ƒm tra:
1. Log file: `bot_agent.log`
2. System resources: `/sys` command
3. Ollama status: `ollama ps`
4. Python version: `python3 --version` (cáº§n 3.10+)

---

**Enjoy your local AI Agent! ğŸš€**
